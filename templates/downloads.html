{% extends "base.html" %}

{% block title %}Downloads - FDL Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Downloads</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDownloadModal">
            <i class="bi bi-download"></i> Add Download
        </button>
    </div>
</div>

<ul class="nav nav-tabs mb-3" id="downloadsTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button" role="tab" aria-controls="active" aria-selected="true">Active</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">History</button>
    </li>
</ul>

<div class="tab-content" id="downloadsTabContent">
    <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="active-downloads">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Progress</th>
                        <th>Speed</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Active downloads will be populated via JavaScript -->
                    <tr class="no-downloads-row">
                        <td colspan="5" class="text-center">No active downloads</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="download-history">
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Status</th>
                        <th>Started</th>
                        <th>Completed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Download history will be populated via JavaScript -->
                    <tr class="no-downloads-row">
                        <td colspan="5" class="text-center">No download history</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Download Modal -->
<div class="modal fade" id="addDownloadModal" tabindex="-1" aria-labelledby="addDownloadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDownloadModalLabel">Add New Download</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="downloadForm">
                    <div class="mb-3">
                        <label for="downloadUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="downloadUrl" placeholder="https://example.com/file.zip" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startDownload">Start Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to load active downloads
    function loadActiveDownloads() {
        fetch('/api/downloads/active')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#active-downloads tbody');
                tbody.innerHTML = '';
                
                if (data.downloads && data.downloads.length > 0) {
                    data.downloads.forEach(download => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${download.filename}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${download.progress}%" 
                                         aria-valuenow="${download.progress}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${download.progress.toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                            <td>${download.speed || 'N/A'}</td>
                            <td>${download.status}</td>
                            <td>
                                <button class="btn btn-sm btn-danger cancel-btn" data-id="${download.id}">
                                    Cancel
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Add event listeners for cancel buttons
                    document.querySelectorAll('.cancel-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const downloadId = this.getAttribute('data-id');
                            cancelDownload(downloadId);
                        });
                    });
                } else {
                    tbody.innerHTML = `
                        <tr class="no-downloads-row">
                            <td colspan="5" class="text-center">No active downloads</td>
                        </tr>
                    `;
                }
            })
            .catch(error => console.error('Error loading active downloads:', error));
    }

    // Function to load download history
    function loadDownloadHistory() {
        fetch('/api/downloads/history')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#download-history tbody');
                tbody.innerHTML = '';
                
                if (data.history && data.history.length > 0) {
                    // Sort history by start time (newest first)
                    const sortedHistory = [...data.history].sort((a, b) => b.start_time - a.start_time);
                    
                    sortedHistory.forEach(download => {
                        const startDate = new Date(download.start_time * 1000).toLocaleString();
                        const endDate = download.end_time ? 
                            new Date(download.end_time * 1000).toLocaleString() : 'N/A';
                        
                        const row = document.createElement('tr');
                        
                        let actionButtons = '';
                        if (download.status === 'completed') {
                            actionButtons = `
                                <a href="/download/${download.id}" class="btn btn-sm btn-success">
                                    Download
                                </a>
                            `;
                        }
                        
                        row.innerHTML = `
                            <td>${download.filename}</td>
                            <td>
                                <span class="badge ${getBadgeClass(download.status)}">
                                    ${download.status}
                                </span>
                            </td>
                            <td>${startDate}</td>
                            <td>${endDate}</td>
                            <td>${actionButtons}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr class="no-downloads-row">
                            <td colspan="5" class="text-center">No download history</td>
                        </tr>
                    `;
                }
            })
            .catch(error => console.error('Error loading download history:', error));
    }

    function getBadgeClass(status) {
        switch(status) {
            case 'completed': return 'bg-success';
            case 'failed': return 'bg-danger';
            case 'cancelled': return 'bg-warning';
            default: return 'bg-secondary';
        }
    }

    // Function to start a new download
    function startDownload(url) {
        fetch('/api/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                loadActiveDownloads();
            }
        })
        .catch(error => console.error('Error starting download:', error));
    }

    // Function to cancel a download
    function cancelDownload(downloadId) {
        fetch(`/api/download/${downloadId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                loadActiveDownloads();
                loadDownloadHistory();
            }
        })
        .catch(error => console.error('Error cancelling download:', error));
    }

    // Event listener for the start download button
    document.getElementById('startDownload').addEventListener('click', function() {
        const url = document.getElementById('downloadUrl').value;
        if (url) {
            startDownload(url);
            document.getElementById('downloadUrl').value = '';
            document.querySelector('#addDownloadModal .btn-close').click();
        }
    });

    // Event listener for tab changes to load relevant data
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            if (event.target.id === 'history-tab') {
                loadDownloadHistory();
            } else if (event.target.id === 'active-tab') {
                loadActiveDownloads();
            }
        });
    });

    // Load initial data when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadActiveDownloads();
        
        // Refresh active downloads periodically
        setInterval(loadActiveDownloads, 2000);
    });
</script>
{% endblock %}
