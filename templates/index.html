{% extends "base.html" %}

{% block title %}Dashboard - FDL Server{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDownloadModal">
            <i class="bi bi-download"></i> Add Download
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Active Downloads</h5>
                <h1 class="display-4" id="active-count">-</h1>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Completed Downloads</h5>
                <h1 class="display-4" id="completed-count">-</h1>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Failed Downloads</h5>
                <h1 class="display-4" id="failed-count">-</h1>
            </div>
        </div>
    </div>
</div>

<h3 class="mt-4">Active Downloads</h3>
<div class="table-responsive">
    <table class="table table-striped table-sm" id="active-downloads">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Progress</th>
                <th>Speed</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Active downloads will be populated via JavaScript -->
            <tr class="no-downloads-row">
                <td colspan="5" class="text-center">No active downloads</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add Download Modal -->
<div class="modal fade" id="addDownloadModal" tabindex="-1" aria-labelledby="addDownloadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDownloadModalLabel">Add New Download</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="downloadForm">
                    <div class="mb-3">
                        <label for="downloadUrl" class="form-label">URL</label>
                        <input type="url" class="form-control" id="downloadUrl" placeholder="https://example.com/file.zip" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startDownload">Start Download</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to load dashboard stats
    function loadDashboardStats() {
        fetch('/api/system/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('active-count').textContent = data.active_downloads;
                document.getElementById('completed-count').textContent = data.completed_downloads;
                document.getElementById('failed-count').textContent = data.failed_downloads;
            })
            .catch(error => console.error('Error loading system stats:', error));
    }

    // Function to load active downloads
    function loadActiveDownloads() {
        fetch('/api/downloads/active')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#active-downloads tbody');
                tbody.innerHTML = '';
                
                if (data.downloads && data.downloads.length > 0) {
                    data.downloads.forEach(download => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${download.filename}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${download.progress}%" 
                                         aria-valuenow="${download.progress}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        ${download.progress.toFixed(1)}%
                                    </div>
                                </div>
                            </td>
                            <td>${download.speed || 'N/A'}</td>
                            <td>${download.status}</td>
                            <td>
                                <button class="btn btn-sm btn-danger cancel-btn" data-id="${download.id}">
                                    Cancel
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Add event listeners for cancel buttons
                    document.querySelectorAll('.cancel-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const downloadId = this.getAttribute('data-id');
                            cancelDownload(downloadId);
                        });
                    });
                } else {
                    tbody.innerHTML = `
                        <tr class="no-downloads-row">
                            <td colspan="5" class="text-center">No active downloads</td>
                        </tr>
                    `;
                }
            })
            .catch(error => console.error('Error loading active downloads:', error));
    }

    // Function to start a new download
    function startDownload(url) {
        fetch('/api/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                loadActiveDownloads();
                loadDashboardStats();
            }
        })
        .catch(error => console.error('Error starting download:', error));
    }

    // Function to cancel a download
    function cancelDownload(downloadId) {
        fetch(`/api/download/${downloadId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                loadActiveDownloads();
                loadDashboardStats();
            }
        })
        .catch(error => console.error('Error cancelling download:', error));
    }

    // Event listener for the start download button
    document.getElementById('startDownload').addEventListener('click', function() {
        const url = document.getElementById('downloadUrl').value;
        if (url) {
            startDownload(url);
            document.getElementById('downloadUrl').value = '';
            document.querySelector('#addDownloadModal .btn-close').click();
        }
    });

    // Load data when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardStats();
        loadActiveDownloads();
        
        // Refresh data periodically
        setInterval(loadDashboardStats, 5000);
        setInterval(loadActiveDownloads, 2000);
    });
</script>
{% endblock %}
